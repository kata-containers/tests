# Copyright (c) 2023 Intel Corporation
#
# SPDX-License-Identifier: Apache-2.0
#
apiVersion: v1
kind: Pod
metadata:
  name: secret-test-pod-cc
  annotations:
    io.containerd.cri.runtime-handler: $RUNTIMECLASS
spec:
  runtimeClassName: $RUNTIMECLASS
  containers:
  - name: busybox
    image: quay.io/prometheus/busybox:latest
    imagePullPolicy: Always
    command:
    - sh
    - -c
    - |
      env
      if [ "$SECRET_PASSWORD" == "unsealed_secret" ]; then
        echo "unsealed environment as expected"
      fi

      if [ -f /tmp/secret-volume/password ]; then
        content=$(cat /tmp/secret-volume/password)
        if [ "$content" == "unsealed_secret" ]; then
          echo "unsealed volume as expected";
        fi
      fi

      sleep 1000

    # Expose secret data Containers through environment.
    env:
    - name: SECRET_PASSWORD
      valueFrom:
        secretKeyRef:
          name: sealed-secret
          key: password
    volumeMounts:
        # name must match the volume name below
        - name: secret-volume
          mountPath: /tmp/secret-volume
  # Expose secret data Containers through a volume.
  volumes:
    - name: secret-volume
      secret:
        secretName: sealed-secret
